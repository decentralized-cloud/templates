parameters:
  version: ""
  publishServiceDockerImage: true
  vmImage: ""
  gitVersion: ""
  gitVersionConfigFilePath: ""
  contractScriptFilePath: ""
  contractScriptworkingDirectory: ""
  dockerContainerRegistry: ""
  dockerRepositoryName: ""
  dockerBuildFilePath: ""
  dockerBuildContext: ""
  testDockerComposeFilePath: ""
  ciService: ""
  coverallsToken: ""
  helmVersion: ""
  helmChartsDirectoryPath: ""
  helmChartsOutputDirectoryPath: ""
  helmArtifactName: ""
  shouldPublishHelmChart: false
  buildAndPushHelmChartDockerFilePath: ""
  buildAndPushHelmChartDockerBuildContext: ""
  githubAccessCredentials: ""

jobs:
  - job: Build_Publish
    pool:
      vmImage: ${{ parameters.vmImage }}
    steps:
      - template: steps/gitversion.yml
      - template: steps/build-contract.yml
        parameters:
          contractScriptFilePath: ${{ parameters.contractScriptFilePath }}
          contractScriptworkingDirectory: ${{ parameters.contractScriptworkingDirectory }}

      - template: steps/build-service.yml
        parameters:
          dockerRepositoryName: ${{ parameters.dockerRepositoryName }}
          dockerBuildFilePath: ${{ parameters.dockerBuildFilePath }}
          buildContext: ${{ parameters.dockerBuildContext }}
          version: ${{ parameters.version }}

      - ${{ if eq(parameters.publishServiceDockerImage, true) }}:
          - template: steps/publish-service.yml
            parameters:
              dockerRepositoryName: ${{ parameters.dockerRepositoryName }}
              dockerContainerRegistry: ${{ parameters.dockerContainerRegistry }}
              buildContext: ${{ parameters.dockerBuildContext }}
              version: ${{ parameters.version }}

  - job: Test_Publish_Results
    pool:
      vmImage: ${{ parameters.vmImage }}
    steps:
      - template: steps/build-contract.yml
        parameters:
          contractScriptFilePath: ${{ parameters.contractScriptFilePath }}
          contractScriptworkingDirectory: ${{ parameters.contractScriptworkingDirectory }}

      - template: steps/test-service.yml
        parameters:
          testDockerComposeFilePath: ${{ parameters.testDockerComposeFilePath }}
          ciService: ${{ parameters.ciService }}
          coverallsToken: ${{ parameters.coverallsToken }}

  - job: Build_Publish_Helm_As_Artifact
    pool:
      vmImage: ${{ parameters.vmImage }}
    steps:
      - template: steps/gitversion.yml
      - template: steps/build-publish-helm-as-artifact.yml
        parameters:
          helmVersion: ${{ parameters.helmVersion }}
          helmChartsDirectoryPath: ${{ parameters.helmChartsDirectoryPath }}
          helmChartsOutputDirectoryPath: ${{ parameters.helmChartsOutputDirectoryPath }}
          helmArtifactName: ${{ parameters.helmArtifactName }}
          appVersion: ${{ parameters.version }}

  - ${{ if eq(parameters.shouldPublishHelmChart, true) }}:
      - job: Build_Publish_Helm
        pool:
          vmImage: ${{ parameters.vmImage }}
        steps:
          - template: steps/gitversion.yml
          - template: steps/build-publish-helm.yml
            parameters:
              buildAndPushHelmChartDockerFilePath: ${{ parameters.buildAndPushHelmChartDockerFilePath }}
              buildContext: ${{ parameters.buildAndPushHelmChartDockerBuildContext }}
              githubAccessCredentials: ${{ parameters.githubAccessCredentials }}
              version: ${{ parameters.version }}
